<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ò–¢–°–°-–û-23/1 | –û—Å–µ–Ω—å 2025‚Äì2026</title>
    <meta name="description" content="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –≥—Ä—É–ø–ø—ã –ò–¢–°–°-–û-23/1 –Ω–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä 2025-2026">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="inter.css">
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-glass: rgba(22, 33, 62, 0.7);
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b8;
            --text-muted: #6c6c80;
            --accent-1: #7c3aed;
            --accent-2: #2563eb;
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(124, 58, 237, 0.4);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

            /* Subject colors */
            --subj-rmp: #7c3aed;
            --subj-tt: #2563eb;
            --subj-msk: #0891b2;
            --subj-toi: #059669;
            --subj-emf: #d97706;
            --subj-opis: #dc2626;
            --subj-ost: #e11d48;
            --subj-pe: #6366f1;
            --subj-sport: #64748b;
            --subj-practice: #8b5cf6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 30% 20%, rgba(124, 58, 237, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(37, 99, 235, 0.06) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite alternate;
        }

        @keyframes bgShift {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-5%, -3%);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px 60px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(37, 99, 235, 0.15));
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 100px;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 16px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #e8e8f0, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Week toggle */
        .week-toggle {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 4px;
            max-width: 340px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border);
        }

        .week-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 11px;
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
            background: transparent;
        }

        .week-btn.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: #fff;
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
        }

        .week-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.04);
        }

        /* Time info bar */
        .time-info {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .time-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .time-chip .icon {
            font-size: 14px;
        }

        .next-class {
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(37, 99, 235, 0.16));
            border: 1px solid rgba(124, 58, 237, 0.28);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.22);
        }

        .next-class-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .next-class-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: rgba(232, 232, 240, 0.85);
        }

        .next-class-timer {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 15, 26, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .next-class-name {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            line-height: 1.35;
            margin-bottom: 6px;
        }

        .next-class-meta {
            font-size: 13px;
            color: rgba(232, 232, 240, 0.9);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .next-class-muted {
            font-size: 13px;
            color: rgba(232, 232, 240, 0.8);
        }

        .control-panel {
            margin-bottom: 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            display: grid;
            gap: 10px;
        }

        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .panel-input,
        .panel-select,
        .panel-btn {
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            padding: 7px 10px;
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .panel-input {
            min-width: 170px;
        }

        .panel-select {
            min-width: 96px;
            color: var(--text-primary);
            background-color: rgba(15, 15, 26, 0.85);
        }

        .panel-select option {
            color: #e5e7eb;
            background-color: #111827;
        }

        .panel-btn {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .panel-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .panel-btn.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-color: transparent;
            color: #fff;
        }

        .panel-tag {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
        }

        .offline-banner {
            display: none;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(220, 38, 38, 0.18);
            border: 1px solid rgba(220, 38, 38, 0.35);
            color: #fecaca;
        }

        .offline-banner.show {
            display: block;
        }

        .changelog-banner {
            display: none;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
            background: rgba(37, 99, 235, 0.18);
            border: 1px solid rgba(37, 99, 235, 0.35);
            color: #bfdbfe;
        }

        .changelog-banner.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .stats-bar {
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
        }

        .stats-chip {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stats-chip strong {
            color: var(--text-primary);
            font-weight: 700;
        }

        /* Schedule grid */
        .schedule {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .day-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .day-card:hover {
            border-color: var(--border-active);
            box-shadow: 0 4px 24px rgba(124, 58, 237, 0.08);
        }

        .day-card.today {
            border-color: rgba(124, 58, 237, 0.4);
            box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.15), 0 4px 24px rgba(124, 58, 237, 0.1);
        }

        .day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        .day-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-name {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .day-card.today .day-name {
            background: linear-gradient(135deg, #a78bfa, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .today-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            padding: 3px 10px;
            border-radius: 100px;
        }

        .class-count {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .day-expand-icon {
            color: var(--text-muted);
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .day-card.collapsed .day-expand-icon {
            transform: rotate(-90deg);
        }

        .day-body {
            padding: 4px 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: max-height 0.4s ease, opacity 0.3s ease;
        }

        .day-card.collapsed .day-body {
            display: none;
        }

        /* Class row */
        .class-row {
            display: flex;
            align-items: stretch;
            gap: 12px;
            padding: 10px 8px;
            border-radius: 10px;
            transition: background 0.2s ease;
        }

        .class-row.status-now {
            background: rgba(34, 197, 94, 0.12);
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        .class-row.status-soon {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.22);
        }

        .class-row.status-past {
            opacity: 0.75;
        }

        .class-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .class-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 52px;
            gap: 2px;
        }

        .class-time .pair-num {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.04);
        }

        .class-time .time-start {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .class-time .time-end {
            font-size: 11px;
            color: var(--text-muted);
        }

        .class-divider {
            width: 3px;
            border-radius: 3px;
            flex-shrink: 0;
            opacity: 0.8;
        }

        .class-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 2px 0;
        }

        .class-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .class-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            padding: 2px 7px;
            border-radius: 5px;
        }

        .status-now-badge {
            color: #86efac;
            background: rgba(34, 197, 94, 0.15);
        }

        .status-soon-badge {
            color: #93c5fd;
            background: rgba(59, 130, 246, 0.15);
        }

        .status-past-badge {
            color: #cbd5e1;
            background: rgba(148, 163, 184, 0.16);
        }

        .class-teacher {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .class-type {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 5px;
            text-transform: uppercase;
        }

        .type-lek {
            background: rgba(34, 197, 94, 0.12);
            color: #4ade80;
        }

        .type-sem {
            background: rgba(251, 191, 36, 0.12);
            color: #fbbf24;
        }

        .type-lab {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
        }

        .class-room {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .class-room::before {
            content: 'üìç';
            font-size: 11px;
        }

        .share-btn {
            margin-left: auto;
            font-size: 11px;
            color: #dbeafe;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(30, 41, 59, 0.45);
            border-radius: 6px;
            padding: 3px 8px;
            cursor: pointer;
        }

        .class-name mark {
            background: rgba(250, 204, 21, 0.35);
            color: #fef9c3;
            border-radius: 4px;
            padding: 0 2px;
        }

        /* Empty slot */
        .empty-note {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        /* Practice day */
        .practice-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 24px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }

        .practice-banner .icon {
            font-size: 24px;
        }

        /* Legend */
        .legend {
            margin-top: 32px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 20px;
        }

        .legend h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-abbr {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Time slots reference */
        .time-ref {
            margin-top: 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 20px;
        }

        .time-ref h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 6px;
        }

        .time-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .time-slot-num {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
        }

        .time-slot-range {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Mobile */
        @media (max-width: 640px) {
            .container {
                padding: 16px 10px 40px;
            }

            .header h1 {
                font-size: 22px;
            }

            .day-header {
                padding: 12px 14px;
            }

            .day-body {
                padding: 4px 6px 8px;
            }

            .class-row {
                gap: 8px;
                padding: 8px 4px;
            }

            .class-time {
                min-width: 44px;
            }

            .class-name {
                font-size: 13px;
            }

            .time-info {
                gap: 8px;
            }

            .next-class {
                padding: 14px;
            }

            .next-class-head {
                flex-direction: column;
                align-items: flex-start;
            }

            .next-class-timer {
                font-size: 14px;
            }

            .next-class-name {
                font-size: 15px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }

            .time-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .panel-input,
            .panel-select {
                min-width: 120px;
                flex: 1;
            }

            .panel-btn {
                flex: 1;
            }

            .stats-bar {
                grid-template-columns: 1fr;
            }
        }

        /* Transition for week switch */
        .schedule.fade-out {
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s ease;
        }

        .schedule.fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        /* Notification banner */
        .notif-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            padding: 12px 24px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 500;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 90vw;
        }

        .notif-banner:hover {
            transform: translateX(-50%) scale(1.02);
        }

        .notif-banner .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notif-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 100px;
            margin-left: 8px;
        }

        .notif-status.on {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .notif-status.off {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }
    </style>
</head>

<body>
    <div class="bg-gradient"></div>

    <div class="container">
        <header class="header">
            <div class="header-badge">
                <span class="dot"></span>
                –û—Å–µ–Ω—å 2025‚Äì2026
            </div>
            <h1>–ò–¢–°–°-–û-23/1</h1>
            <p>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</p>
        </header>

        <div class="week-toggle">
            <button class="week-btn active" data-week="1" type="button">1 –Ω–µ–¥. (–Ω–µ—á—ë—Ç–Ω–∞—è)</button>
            <button class="week-btn" data-week="2" type="button">2 –Ω–µ–¥. (—á—ë—Ç–Ω–∞—è)</button>
        </div>

        <div class="offline-banner" id="offlineBanner">‚ö† –ù–µ—Ç —Å–µ—Ç–∏. –ü–æ–∫–∞–∑–∞–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</div>

        <div class="changelog-banner" id="changelogBanner">
            <span id="changelogText">–ï—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</span>
            <button class="panel-btn" id="changelogCloseBtn" type="button">–°–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="control-panel">
            <div class="panel-row">
                <button class="panel-btn" id="todayModeBtn" type="button">–†–µ–∂–∏–º –°–µ–≥–æ–¥–Ω—è</button>
                <input class="panel-input" id="searchInput" type="search" placeholder="–ü–æ–∏—Å–∫: –ø—Ä–µ–¥–º–µ—Ç/–ø—Ä–µ–ø–æ–¥/–∞—É–¥–∏—Ç–æ—Ä–∏—è">
                <select class="panel-select" id="typeFilter">
                    <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="–õ–ï–ö">–õ–µ–∫—Ü–∏–∏</option>
                    <option value="–°–ï–ú">–°–µ–º–∏–Ω–∞—Ä—ã</option>
                    <option value="–õ–ê–ë">–õ–∞–±—ã</option>
                    <option value="none">–ë–µ–∑ —Ç–∏–ø–∞</option>
                </select>
                <button class="panel-btn" id="exportTodayBtn" type="button">ICS: –°–µ–≥–æ–¥–Ω—è</button>
                <button class="panel-btn" id="exportWeekBtn" type="button">ICS: –ù–µ–¥–µ–ª—è</button>
            </div>
            <div class="panel-row">
                <span class="panel-tag">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ –ø–∞—Ä—ã:</span>
                <select class="panel-select" id="notifLeadTime">
                    <option value="5">5 –º–∏–Ω</option>
                    <option value="10">10 –º–∏–Ω</option>
                    <option value="15" selected>15 –º–∏–Ω</option>
                    <option value="30">30 –º–∏–Ω</option>
                </select>
                <button class="panel-btn" id="shareTodayBtn" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–Ω–µ–º</button>
                <button class="panel-btn" id="resetStateBtn" type="button">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>

        <div class="time-info" id="currentInfo"></div>

        <div class="next-class" id="nextClassCard"></div>

        <div class="stats-bar" id="statsBar"></div>

        <div class="schedule" id="schedule"></div>

        <div class="legend">
            <h3>–¢–∏–ø—ã –∑–∞–Ω—è—Ç–∏–π</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="class-type type-lek">–õ–ï–ö</span>
                    <span class="legend-text">–õ–µ–∫—Ü–∏—è</span>
                </div>
                <div class="legend-item">
                    <span class="class-type type-sem">–°–ï–ú</span>
                    <span class="legend-text">–°–µ–º–∏–Ω–∞—Ä</span>
                </div>
                <div class="legend-item">
                    <span class="class-type type-lab">–õ–ê–ë</span>
                    <span class="legend-text">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞</span>
                </div>
            </div>
        </div>

        <div class="time-ref">
            <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</h3>
            <div class="time-grid" id="timeGrid"></div>
        </div>
    </div>

    <script>
        const TIME_SLOTS = [
            { num: 1, start: '8:00', end: '9:20' },
            { num: 2, start: '9:30', end: '10:50' },
            { num: 3, start: '11:00', end: '12:20' },
            { num: 4, start: '12:45', end: '14:05' },
            { num: 5, start: '14:15', end: '15:35' },
            { num: 6, start: '15:45', end: '17:05' },
            { num: 7, start: '17:15', end: '18:35' },
            { num: 8, start: '18:40', end: '20:00' },
        ];

        const DAYS = ['–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö', '–í–¢–û–†–ù–ò–ö', '–°–†–ï–î–ê', '–ß–ï–¢–í–ï–†–ì', '–ü–Ø–¢–ù–ò–¶–ê'];
        const DAY_LABELS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
        const STORAGE_WEEK_KEY = 'schedule:selectedWeek';
        const STORAGE_COLLAPSED_DAYS_KEY = 'schedule:collapsedDays';
        const STORAGE_TODAY_MODE_KEY = 'schedule:todayMode';
        const STORAGE_TYPE_FILTER_KEY = 'schedule:typeFilter';
        const STORAGE_SEARCH_QUERY_KEY = 'schedule:searchQuery';
        const STORAGE_NOTIF_LEAD_TIME_KEY = 'schedule:notifLeadTime';
        const STORAGE_SCHEDULE_HASH_KEY = 'schedule:dataHash';
        const STORAGE_CHANGELOG_DISMISSED_KEY = 'schedule:changelogDismissed';
        const APP_SCHEDULE_VERSION = '2026-spring-v2';
        const SW_VERSION = '3';

        const SUBJECT_COLORS = {
            '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π': '#7c3aed',
            '–¢–µ–æ—Ä–∏—è —Ç–µ–ª–µ—Ç—Ä–∞—Ñ–∏–∫–∞': '#2563eb',
            '–ú–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è': '#0891b2',
            '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏': '#059669',
            '–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–ª—è –∏ –≤–æ–ª–Ω—ã': '#d97706',
            '–û—Å–Ω–æ–≤—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–µ—Ç–µ–π': '#dc2626',
            '–û—Å–Ω–æ–≤—ã —Å–µ—Ç–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π': '#e11d48',
            '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–∫—Ç–∏–≤': '#6366f1',
            '–≠–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ —Å–ø–æ—Ä—Ç—É': '#64748b',
            '–≠–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ —Å–ø–æ—Ä—Ç—É': '#64748b',
            '–ü—Ä–∞–∫—Ç–∏–∫–∞': '#8b5cf6',
        };

        function getColor(name) {
            for (const key in SUBJECT_COLORS) {
                if (name.startsWith(key) || name.includes(key)) return SUBJECT_COLORS[key];
            }
            return '#6366f1';
        }

        // Schedule data
        const scheduleData = {
            1: { // Week 1
                '–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö': [
                    { pair: 4, name: '–≠–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ —Å–ø–æ—Ä—Ç—É', teacher: '', type: '', room: '' },
                    { pair: 5, name: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π', teacher: '–ë—É–ª–∞–µ–≤ –ê. –ê.', type: '–õ–ï–ö', room: '377' },
                    { pair: 6, name: '–¢–µ–æ—Ä–∏—è —Ç–µ–ª–µ—Ç—Ä–∞—Ñ–∏–∫–∞', teacher: '–ì–ª–∞–¥–∫–∏—Ö –ê. –ê.', type: '–õ–ï–ö', room: '3/213' },
                    { pair: 7, name: '–¢–µ–æ—Ä–∏—è —Ç–µ–ª–µ—Ç—Ä–∞—Ñ–∏–∫–∞', teacher: '–ì–ª–∞–¥–∫–∏—Ö –ê. –ê.', type: '–°–ï–ú', room: '3/213' },
                    { pair: 8, name: '–¢–µ–æ—Ä–∏—è —Ç–µ–ª–µ—Ç—Ä–∞—Ñ–∏–∫–∞', teacher: '–ì–ª–∞–¥–∫–∏—Ö –ê. –ê.', type: '–°–ï–ú', room: '3/214' },
                ],
                '–í–¢–û–†–ù–ò–ö': [
                    { pair: 3, name: '–ú–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö', teacher: '–°–º–∞–≥–∏–Ω –ê. –ê.', type: '–°–ï–ú', room: '3/213' },
                    { pair: 4, name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', teacher: '–ß–µ–∫–∞–ª –ï. –ì.', type: '–õ–ê–ë', room: '3/213' },
                    { pair: 6, name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', teacher: '–ß–µ–∫–∞–ª –ï. –ì.', type: '–õ–ê–ë', room: '3/215' },
                ],
                '–°–†–ï–î–ê': 'practice',
                '–ß–ï–¢–í–ï–†–ì': [
                    { pair: 1, name: '–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–ª—è –∏ –≤–æ–ª–Ω—ã', teacher: '–°–∞–±–∏—Ç–æ–≤ –û. –Æ.', type: '–õ–ï–ö', room: '3/418' },
                    { pair: 2, name: '–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–ª—è –∏ –≤–æ–ª–Ω—ã', teacher: '–°–∞–±–∏—Ç–æ–≤ –û. –Æ.', type: '–°–ï–ú', room: '324' },
                    { pair: 3, name: '–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–ª—è –∏ –≤–æ–ª–Ω—ã', teacher: '–°–∞–±–∏—Ç–æ–≤ –û. –Æ.', type: '–õ–ê–ë', room: '324' },
                    { pair: 4, name: '–≠–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ —Å–ø–æ—Ä—Ç—É', teacher: '', type: '', room: '' },
                ],
                '–ü–Ø–¢–ù–ò–¶–ê': [
                    { pair: 4, name: '–û—Å–Ω–æ–≤—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–µ—Ç–µ–π', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                    { pair: 5, name: '–û—Å–Ω–æ–≤—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–µ—Ç–µ–π', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                    { pair: 6, name: '–û—Å–Ω–æ–≤—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–µ—Ç–µ–π', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                ],
            },
            2: { // Week 2
                '–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö': [
                    { pair: 2, name: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π', teacher: '–ë—É–ª–∞–µ–≤ –ê. –ê.', type: '–õ–ê–ë', room: '4/205' },
                    { pair: 3, name: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π', teacher: '–ë—É–ª–∞–µ–≤ –ê. –ê.', type: '–õ–ê–ë', room: '4/205' },
                ],
                '–í–¢–û–†–ù–ò–ö': [
                    { pair: 3, name: '–ú–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö', teacher: '–°–º–∞–≥–∏–Ω –ê. –ê.', type: '–õ–ï–ö', room: '3/213' },
                    { pair: 4, name: '–ú–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö', teacher: '–°–º–∞–≥–∏–Ω –ê. –ê.', type: '–õ–ê–ë', room: '3/214' },
                    { pair: 5, name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–∫—Ç–∏–≤. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ-–∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –ò–°', teacher: '–õ—É–∫—å—è–Ω–æ–≤ –í. –ê.', type: '–õ–ï–ö', room: '3/217' },
                    { pair: 6, name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–∫—Ç–∏–≤. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ-–∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –ò–°', teacher: '–õ—É–∫—å—è–Ω–æ–≤ –í. –ê.', type: '–õ–ê–ë', room: '3/213' },
                ],
                '–°–†–ï–î–ê': 'practice',
                '–ß–ï–¢–í–ï–†–ì': [
                    { pair: 4, name: '–≠–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ —Å–ø–æ—Ä—Ç—É', teacher: '', type: '', room: '' },
                ],
                '–ü–Ø–¢–ù–ò–¶–ê': [
                    { pair: 4, name: '–û—Å–Ω–æ–≤—ã —Å–µ—Ç–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –∏ —Å–µ—Ä–≤–∏—Å–∞—Ö', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                    { pair: 5, name: '–û—Å–Ω–æ–≤—ã —Å–µ—Ç–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –∏ —Å–µ—Ä–≤–∏—Å–∞—Ö', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                    { pair: 6, name: '–û—Å–Ω–æ–≤—ã —Å–µ—Ç–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –∏–Ω—Ñ–æ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –∏ —Å–µ—Ä–≤–∏—Å–∞—Ö', teacher: '–°–º–æ–ª–µ—Ö–∞ –í. –ü.', type: '', room: '2/24–ê' },
                    { pair: 7, name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', teacher: '–ß–µ–∫–∞–ª –ï. –ì.', type: '–õ–ê–ë', room: '3/215' },
                ],
            },
        };

        // === AUTO WEEK DETECTION ===
        // Semester start: Feb 9, 2026 (Monday)
        // Week 24 (Feb 9-15) = —á—ë—Ç–Ω–∞—è = 2 –Ω–µ–¥–µ–ª—è
        // Week 25 (Feb 16-22) = –Ω–µ—á—ë—Ç–Ω–∞—è = 1 –Ω–µ–¥–µ–ª—è
        const SEMESTER_START = new Date(2026, 1, 9); // Feb 9, 2026

        function detectWeekForDate(date) {
            const diffMs = date - SEMESTER_START;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return 2;
            const weekOffset = Math.floor(diffDays / 7);
            return (weekOffset % 2 === 0) ? 2 : 1;
        }

        function detectCurrentWeek() {
            return detectWeekForDate(new Date());
        }

        function getWeekLabel(week) {
            return week === 1 ? '–Ω–µ—á—ë—Ç–Ω–∞—è' : '—á—ë—Ç–Ω–∞—è';
        }

        function getSavedWeek() {
            const raw = localStorage.getItem(STORAGE_WEEK_KEY);
            const parsed = Number.parseInt(raw, 10);
            return (parsed === 1 || parsed === 2) ? parsed : null;
        }

        function getSavedCollapsedDays() {
            try {
                const parsed = JSON.parse(localStorage.getItem(STORAGE_COLLAPSED_DAYS_KEY) || '[]');
                if (!Array.isArray(parsed)) return new Set();
                const valid = parsed
                    .map(v => Number.parseInt(v, 10))
                    .filter(v => v >= 1 && v <= 5);
                return new Set(valid);
            } catch {
                return new Set();
            }
        }

        function saveCollapsedDays() {
            localStorage.setItem(STORAGE_COLLAPSED_DAYS_KEY, JSON.stringify(Array.from(collapsedDays)));
        }

        function getSavedBool(key, defaultValue = false) {
            const value = localStorage.getItem(key);
            if (value === null) return defaultValue;
            return value === '1';
        }

        function getSavedString(key, defaultValue = '') {
            const value = localStorage.getItem(key);
            return value === null ? defaultValue : value;
        }

        function getSavedInt(key, defaultValue) {
            const value = Number.parseInt(localStorage.getItem(key), 10);
            return Number.isNaN(value) ? defaultValue : value;
        }

        function stringHash(input) {
            let hash = 5381;
            for (let i = 0; i < input.length; i += 1) {
                hash = ((hash << 5) + hash) + input.charCodeAt(i);
                hash |= 0;
            }
            return String(hash >>> 0);
        }

        function computeScheduleHash() {
            return `${APP_SCHEDULE_VERSION}:${stringHash(JSON.stringify(scheduleData))}`;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeRegExp(value) {
            return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightMatch(text, query) {
            if (!query) return escapeHtml(text);
            const safe = escapeRegExp(query.trim());
            if (!safe) return escapeHtml(text);
            const re = new RegExp(`(${safe})`, 'ig');
            return escapeHtml(text).replace(re, '<mark>$1</mark>');
        }

        function savePanelState() {
            localStorage.setItem(STORAGE_TODAY_MODE_KEY, todayModeEnabled ? '1' : '0');
            localStorage.setItem(STORAGE_TYPE_FILTER_KEY, typeFilterValue);
            localStorage.setItem(STORAGE_SEARCH_QUERY_KEY, searchQueryValue);
            localStorage.setItem(STORAGE_NOTIF_LEAD_TIME_KEY, String(notifLeadTimeMins));
        }

        let currentWeek = getSavedWeek() || detectCurrentWeek();
        const collapsedDays = getSavedCollapsedDays();
        let todayModeEnabled = getSavedBool(STORAGE_TODAY_MODE_KEY, false);
        let typeFilterValue = getSavedString(STORAGE_TYPE_FILTER_KEY, 'all');
        let searchQueryValue = getSavedString(STORAGE_SEARCH_QUERY_KEY, '').trim();
        let notifLeadTimeMins = getSavedInt(STORAGE_NOTIF_LEAD_TIME_KEY, 15);
        if (![5, 10, 15, 30].includes(notifLeadTimeMins)) notifLeadTimeMins = 15;
        const scheduleHash = computeScheduleHash();

        function getTypeClass(type) {
            if (!type) return '';
            const t = type.toUpperCase();
            if (t === '–õ–ï–ö') return 'type-lek';
            if (t === '–°–ï–ú') return 'type-sem';
            if (t === '–õ–ê–ë') return 'type-lab';
            return '';
        }

        function getTodayDayIndex() {
            const d = new Date().getDay(); // 0=Sun, 1=Mon, ... 5=Fri, 6=Sat
            return d; // 1-5 are weekdays
        }

        function classMatchesFilters(c, query, typeFilter) {
            if (typeFilter === 'none' && c.type) return false;
            if (typeFilter !== 'all' && typeFilter !== 'none' && (c.type || '').toUpperCase() !== typeFilter) return false;
            if (!query) return true;
            const q = query.toLowerCase();
            return [c.name, c.teacher, c.room, c.type].some(v => (v || '').toLowerCase().includes(q));
        }

        function getDayStatus(dayNum, pairNum, week, now) {
            if (week !== detectCurrentWeek() || dayNum !== now.getDay()) {
                return { rowClass: '', badgeClass: '', badgeText: '' };
            }
            const slot = TIME_SLOTS[pairNum - 1];
            if (!slot) return { rowClass: '', badgeClass: '', badgeText: '' };
            const [sh, sm] = slot.start.split(':').map(Number);
            const [eh, em] = slot.end.split(':').map(Number);
            const mins = now.getHours() * 60 + now.getMinutes();
            const start = sh * 60 + sm;
            const end = eh * 60 + em;

            if (mins >= start && mins <= end) {
                return { rowClass: ' status-now', badgeClass: ' status-now-badge', badgeText: '–ò–¥–µ—Ç' };
            }
            if (start > mins && (start - mins) <= 60) {
                return { rowClass: ' status-soon', badgeClass: ' status-soon-badge', badgeText: '–°–∫–æ—Ä–æ' };
            }
            if (end < mins) {
                return { rowClass: ' status-past', badgeClass: ' status-past-badge', badgeText: '–ü—Ä–æ—à–ª–∞' };
            }
            return { rowClass: '', badgeClass: '', badgeText: '' };
        }

        function getVisibleDaysForWeek(week) {
            if (!todayModeEnabled) return [1, 2, 3, 4, 5];
            if (week !== detectCurrentWeek()) return [1, 2, 3, 4, 5];
            const day = getTodayDayIndex();
            if (day >= 1 && day <= 5) return [day];
            return [1, 2, 3, 4, 5];
        }

        function renderSchedule(week) {
            const el = document.getElementById('schedule');
            const now = new Date();
            const today = getTodayDayIndex();
            const isCurrentWeek = (week === detectCurrentWeek());
            const visibleDays = getVisibleDaysForWeek(week);
            let html = '';

            visibleDays.forEach((dayNum) => {
                const idx = dayNum - 1;
                const dayName = DAYS[idx];
                const isToday = isCurrentWeek && dayNum === today;
                const data = scheduleData[week][dayName];
                const isPractice = data === 'practice';
                const classes = isPractice ? [] : (data || []);
                const filteredClasses = classes.filter(c => classMatchesFilters(c, searchQueryValue, typeFilterValue));
                const classCount = isPractice ? 0 : filteredClasses.length;

                const isCollapsed = collapsedDays.has(dayNum);

                html += `<div class="day-card${isToday ? ' today' : ''}${isCollapsed ? ' collapsed' : ''}" id="day-${dayNum}">`;
                html += `<div class="day-header" data-day="${dayNum}" role="button" tabindex="0" aria-expanded="${isCollapsed ? 'false' : 'true'}" aria-controls="day-body-${dayNum}">`;
                html += `<div class="day-header-left">`;
                html += `<span class="day-name">${dayName}</span>`;
                if (isToday) html += `<span class="today-badge">–°–µ–≥–æ–¥–Ω—è</span>`;
                html += `</div>`;
                html += `<div style="display:flex;align-items:center;gap:12px;">`;
                if (isPractice) {
                    html += `<span class="class-count">–ü—Ä–∞–∫—Ç–∏–∫–∞</span>`;
                } else if (classCount > 0) {
                    html += `<span class="class-count">${classCount} ${classCount === 1 ? '–ø–∞—Ä–∞' : (classCount < 5 ? '–ø–∞—Ä—ã' : '–ø–∞—Ä')}</span>`;
                } else {
                    html += `<span class="class-count">–ù–µ—Ç –ø–∞—Ä</span>`;
                }
                html += `<span class="day-expand-icon">‚ñæ</span>`;
                html += `</div></div>`;

                html += `<div class="day-body" id="day-body-${dayNum}">`;

                if (isPractice) {
                    html += `<div class="practice-banner"><span class="icon">üèóÔ∏è</span><span>–ü—Ä–∞–∫—Ç–∏–∫–∞ (–≤–µ—Å—å –¥–µ–Ω—å)</span></div>`;
                } else if (classCount === 0) {
                    html += `<div class="empty-note">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –ø–∞—Ä –Ω–µ—Ç</div>`;
                } else {
                    filteredClasses.forEach(c => {
                        const slot = TIME_SLOTS[c.pair - 1];
                        const color = getColor(c.name);
                        const status = getDayStatus(dayNum, c.pair, week, now);
                        html += `<div class="class-row${status.rowClass}" data-day="${dayNum}" data-pair="${c.pair}" data-name="${escapeHtml(c.name)}">`;
                        html += `<div class="class-time"><span class="pair-num">${c.pair}</span><span class="time-start">${slot.start}</span><span class="time-end">${slot.end}</span></div>`;
                        html += `<div class="class-divider" style="background:${color}"></div>`;
                        html += `<div class="class-info">`;
                        html += `<div class="class-name">${highlightMatch(c.name, searchQueryValue)}</div>`;
                        html += `<div class="class-meta">`;
                        if (c.teacher) html += `<span class="class-teacher">${highlightMatch(c.teacher, searchQueryValue)}</span>`;
                        if (c.type) html += `<span class="class-type ${getTypeClass(c.type)}">${c.type}</span>`;
                        if (c.room) html += `<span class="class-room">${highlightMatch(c.room, searchQueryValue)}</span>`;
                        if (status.badgeText) html += `<span class="status-badge${status.badgeClass}">${status.badgeText}</span>`;
                        html += `<button class="share-btn" type="button" data-share="class" data-day="${dayNum}" data-pair="${c.pair}">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>`;
                        html += `</div></div></div>`;
                    });
                }

                html += `</div></div>`;
            });

            if (!html) {
                html = `<div class="day-card"><div class="empty-note">–ù–µ—á–µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.</div></div>`;
            }

            el.innerHTML = html;

            if (isCurrentWeek && today >= 1 && today <= 5) {
                setTimeout(() => {
                    const todayCard = document.getElementById(`day-${today}`);
                    if (todayCard) todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 250);
            }
        }

        function switchWeek(week) {
            if (week === currentWeek) return;
            currentWeek = week;
            localStorage.setItem(STORAGE_WEEK_KEY, String(week));

            document.querySelectorAll('.week-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.week) === week);
            });

            const el = document.getElementById('schedule');
            el.classList.add('fade-out');
            el.classList.remove('fade-in');

            setTimeout(() => {
                renderSchedule(week);
                renderStats();
                renderNextClassCard();
                el.classList.remove('fade-out');
                el.classList.add('fade-in');
            }, 200);
        }

        function toggleDay(dayNum) {
            const card = document.getElementById(`day-${dayNum}`);
            if (!card) return;
            card.classList.toggle('collapsed');
            if (card.classList.contains('collapsed')) {
                collapsedDays.add(dayNum);
            } else {
                collapsedDays.delete(dayNum);
            }
            saveCollapsedDays();
            const header = card.querySelector('.day-header');
            if (header) {
                const expanded = !card.classList.contains('collapsed');
                header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            }
        }

        function formatDuration(ms) {
            if (ms <= 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function pairDateParts(baseDate, pairNum) {
            const slot = TIME_SLOTS[pairNum - 1];
            if (!slot) return null;
            const [sh, sm] = slot.start.split(':').map(Number);
            const [eh, em] = slot.end.split(':').map(Number);
            const start = new Date(baseDate);
            start.setHours(sh, sm, 0, 0);
            const end = new Date(baseDate);
            end.setHours(eh, em, 0, 0);
            return { slot, start, end };
        }

        function buildUpcomingCandidates(fromDate) {
            const result = [];
            for (let offset = 0; offset < 14; offset += 1) {
                const date = new Date(fromDate);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + offset);
                const day = date.getDay();
                if (day < 1 || day > 5) continue;

                const week = detectWeekForDate(date);
                const dayName = DAYS[day - 1];
                const data = scheduleData[week][dayName];
                if (!data || data === 'practice') continue;

                data.forEach(cls => {
                    const parts = pairDateParts(date, cls.pair);
                    if (!parts) return;
                    result.push({
                        ...cls,
                        week,
                        day,
                        dayName,
                        dayLabel: DAY_LABELS[day - 1],
                        slot: parts.slot,
                        start: parts.start,
                        end: parts.end,
                    });
                });
            }
            return result.sort((a, b) => a.start - b.start);
        }

        function getUpcomingClassInfo(now) {
            const candidates = buildUpcomingCandidates(now);
            for (const cls of candidates) {
                if (now >= cls.start && now <= cls.end) {
                    return {
                        mode: 'ongoing',
                        classInfo: cls,
                        countdownText: `–î–æ –∫–æ–Ω—Ü–∞ ${formatDuration(cls.end - now)}`,
                    };
                }
                if (cls.start > now) {
                    return {
                        mode: 'next',
                        classInfo: cls,
                        countdownText: `–î–æ –Ω–∞—á–∞–ª–∞ ${formatDuration(cls.start - now)}`,
                    };
                }
            }
            return null;
        }

        function renderNextClassCard() {
            const el = document.getElementById('nextClassCard');
            const now = new Date();
            const upcoming = getUpcomingClassInfo(now);

            if (!upcoming) {
                el.innerHTML = `
                    <div class="next-class-head">
                        <span class="next-class-label">–ë–ª–∏–∂–∞–π—à–∞—è –ø–∞—Ä–∞</span>
                        <span class="next-class-timer">--:--:--</span>
                    </div>
                    <div class="next-class-muted">–í –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏ –ø–∞—Ä –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
                `;
                return;
            }

            const c = upcoming.classInfo;
            const headline = upcoming.mode === 'ongoing' ? '–°–µ–π—á–∞—Å –∏–¥–µ—Ç –ø–∞—Ä–∞' : '–ë–ª–∏–∂–∞–π—à–∞—è –ø–∞—Ä–∞';
            const typeLabel = c.type ? `${c.type} ¬∑ ` : '';
            const teacherLabel = c.teacher ? ` ¬∑ ${c.teacher}` : '';
            const roomLabel = c.room ? ` ¬∑ –∞—É–¥. ${c.room}` : '';

            el.innerHTML = `
                <div class="next-class-head">
                    <span class="next-class-label">${headline}</span>
                    <span class="next-class-timer">${upcoming.countdownText}</span>
                </div>
                <div class="next-class-name">${c.name}</div>
                <div class="next-class-meta">
                    <span>üìÖ ${c.dayLabel}, ${c.slot.start} - ${c.slot.end}</span>
                    <span>‚Ä¢</span>
                    <span>${typeLabel}${c.pair}-—è –ø–∞—Ä–∞${teacherLabel}${roomLabel}</span>
                </div>
            `;
        }

        function getClassesForDay(week, dayNum) {
            const dayName = DAYS[dayNum - 1];
            const data = scheduleData[week][dayName];
            if (!data || data === 'practice') return [];
            return data;
        }

        function renderStats() {
            const el = document.getElementById('statsBar');
            const visibleDays = getVisibleDaysForWeek(currentWeek);
            let total = 0;
            let labs = 0;
            let lectures = 0;
            let maxDayCount = 0;
            let maxDayLabel = '-';

            visibleDays.forEach(dayNum => {
                const classes = getClassesForDay(currentWeek, dayNum)
                    .filter(c => classMatchesFilters(c, searchQueryValue, typeFilterValue));
                const count = classes.length;
                total += count;
                labs += classes.filter(c => c.type === '–õ–ê–ë').length;
                lectures += classes.filter(c => c.type === '–õ–ï–ö').length;
                if (count > maxDayCount) {
                    maxDayCount = count;
                    maxDayLabel = DAY_LABELS[dayNum - 1];
                }
            });

            el.innerHTML = `
                <div class="stats-chip">–í—Å–µ–≥–æ –ø–∞—Ä: <strong>${total}</strong></div>
                <div class="stats-chip">–õ–µ–∫—Ü–∏–π: <strong>${lectures}</strong> ¬∑ –õ–∞–±: <strong>${labs}</strong></div>
                <div class="stats-chip">–°–∞–º—ã–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π: <strong>${maxDayLabel}</strong> (${maxDayCount})</div>
            `;
        }

        function renderPanelState() {
            const todayBtn = document.getElementById('todayModeBtn');
            todayBtn.classList.toggle('active', todayModeEnabled);
            todayBtn.textContent = todayModeEnabled ? '–†–µ–∂–∏–º –°–µ–≥–æ–¥–Ω—è: –í–ö–õ' : '–†–µ–∂–∏–º –°–µ–≥–æ–¥–Ω—è';

            document.getElementById('typeFilter').value = typeFilterValue;
            document.getElementById('searchInput').value = searchQueryValue;
            document.getElementById('notifLeadTime').value = String(notifLeadTimeMins);
        }

        function applyViewRenders() {
            renderSchedule(currentWeek);
            renderStats();
            renderNextClassCard();
        }

        function buildWeekDateMap(targetWeek, fromDate = new Date()) {
            const start = new Date(fromDate);
            start.setHours(0, 0, 0, 0);
            for (let offset = 0; offset < 21; offset += 1) {
                const date = new Date(start);
                date.setDate(start.getDate() + offset);
                if (date.getDay() === 1 && detectWeekForDate(date) === targetWeek) {
                    return [1, 2, 3, 4, 5].reduce((acc, dayNum) => {
                        const dayDate = new Date(date);
                        dayDate.setDate(date.getDate() + (dayNum - 1));
                        acc[dayNum] = dayDate;
                        return acc;
                    }, {});
                }
            }
            return {};
        }

        function formatDateForICS(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}${m}${d}T${hh}${mm}00`;
        }

        function createICSFile(events, fileName) {
            if (!events.length) return false;
            const lines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ITSS Schedule//RU',
            ];

            events.forEach((event, idx) => {
                lines.push('BEGIN:VEVENT');
                lines.push(`UID:itss-${Date.now()}-${idx}@itss-schedule`);
                lines.push(`DTSTAMP:${formatDateForICS(new Date())}`);
                lines.push(`DTSTART:${formatDateForICS(event.start)}`);
                lines.push(`DTEND:${formatDateForICS(event.end)}`);
                lines.push(`SUMMARY:${event.title}`);
                if (event.location) lines.push(`LOCATION:${event.location}`);
                if (event.description) lines.push(`DESCRIPTION:${event.description}`);
                lines.push('END:VEVENT');
            });

            lines.push('END:VCALENDAR');

            const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            return true;
        }

        function collectEventsForDay(week, dayNum, dateRef) {
            const classes = getClassesForDay(week, dayNum)
                .filter(c => classMatchesFilters(c, searchQueryValue, typeFilterValue));
            return classes.map(c => {
                const parts = pairDateParts(dateRef, c.pair);
                return {
                    title: `${c.name}${c.type ? ` (${c.type})` : ''}`,
                    location: c.room || '',
                    description: [c.teacher || '', `${c.pair}-—è –ø–∞—Ä–∞`].filter(Boolean).join(' ¬∑ '),
                    start: parts.start,
                    end: parts.end,
                };
            });
        }

        function exportTodayICS() {
            const now = new Date();
            const dayNum = now.getDay();
            if (dayNum < 1 || dayNum > 5) return;
            const week = detectCurrentWeek();
            const events = collectEventsForDay(week, dayNum, now);
            createICSFile(events, 'itss-today.ics');
        }

        function exportWeekICS() {
            const dateMap = buildWeekDateMap(currentWeek);
            const events = [1, 2, 3, 4, 5].flatMap(dayNum => {
                const dateRef = dateMap[dayNum];
                if (!dateRef) return [];
                return collectEventsForDay(currentWeek, dayNum, dateRef);
            });
            createICSFile(events, `itss-week-${currentWeek}.ics`);
        }

        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch {
                return false;
            }
        }

        async function shareToday() {
            const now = new Date();
            const dayNum = now.getDay();
            if (dayNum < 1 || dayNum > 5) return;
            const week = detectCurrentWeek();
            const classes = getClassesForDay(week, dayNum);
            const title = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ ${DAY_LABELS[dayNum - 1]} (${week} –Ω–µ–¥.)`;
            const rows = classes.map(c => {
                const slot = TIME_SLOTS[c.pair - 1];
                return `${c.pair}. ${slot.start}-${slot.end} ${c.name}${c.room ? `, –∞—É–¥. ${c.room}` : ''}`;
            });
            const payload = `${title}\n${rows.join('\n') || '–ü–∞—Ä –Ω–µ—Ç'}`;
            await copyText(payload);
        }

        async function shareClass(dayNum, pairNum) {
            const cls = getClassesForDay(currentWeek, dayNum).find(c => c.pair === pairNum);
            if (!cls) return;
            const slot = TIME_SLOTS[cls.pair - 1];
            const text = `${DAY_LABELS[dayNum - 1]}, ${slot.start}-${slot.end} ¬∑ ${cls.name}${cls.teacher ? ` ¬∑ ${cls.teacher}` : ''}${cls.room ? ` ¬∑ –∞—É–¥. ${cls.room}` : ''}`;
            await copyText(text);
        }

        function updateOfflineBanner() {
            const banner = document.getElementById('offlineBanner');
            banner.classList.toggle('show', !navigator.onLine);
        }

        function setupChangelogBanner() {
            const banner = document.getElementById('changelogBanner');
            const text = document.getElementById('changelogText');
            const lastHash = localStorage.getItem(STORAGE_SCHEDULE_HASH_KEY);
            const dismissed = localStorage.getItem(STORAGE_CHANGELOG_DISMISSED_KEY);
            const changed = Boolean(lastHash && lastHash !== scheduleHash);

            if (changed && dismissed !== scheduleHash) {
                text.textContent = '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å: –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
                banner.classList.add('show');
            }

            localStorage.setItem(STORAGE_SCHEDULE_HASH_KEY, scheduleHash);
        }

        function resetSettings() {
            todayModeEnabled = false;
            typeFilterValue = 'all';
            searchQueryValue = '';
            notifLeadTimeMins = 15;
            collapsedDays.clear();
            localStorage.removeItem(STORAGE_COLLAPSED_DAYS_KEY);
            savePanelState();
            renderPanelState();
            applyViewRenders();
        }

        function renderTimeGrid() {
            const el = document.getElementById('timeGrid');
            el.innerHTML = TIME_SLOTS.map(s =>
                `<div class="time-slot">
                    <span class="time-slot-num">${s.num}</span>
                    <span class="time-slot-range">${s.start} ‚Äì ${s.end}</span>
                </div>`
            ).join('');
        }

        function updateCurrentInfo() {
            const now = new Date();
            const el = document.getElementById('currentInfo');
            const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
            const monthNames = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];

            const dayStr = dayNames[now.getDay()];
            const dateStr = `${now.getDate()} ${monthNames[now.getMonth()]}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

            // Week indicator
            const detectedWeek = detectCurrentWeek();
            const weekLabel = getWeekLabel(detectedWeek);
            const notifSupported = ('Notification' in window);
            const notifGranted = notifSupported && Notification.permission === 'granted';
            const notifLabel = !notifSupported
                ? 'üîï –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'
                : (notifGranted ? 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª' : 'üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª');

            // Find current/next pair (only for today's actual schedule)
            let pairInfo = '';
            const todayIdx = now.getDay();
            const isWeekday = todayIdx >= 1 && todayIdx <= 5;

            if (isWeekday) {
                const mins = now.getHours() * 60 + now.getMinutes();
                const pairs = TIME_SLOTS.map(s => {
                    const [sh, sm] = s.start.split(':').map(Number);
                    const [eh, em] = s.end.split(':').map(Number);
                    return { ...s, startMin: sh * 60 + sm, endMin: eh * 60 + em };
                });

                // Check if this pair actually exists in today's schedule
                const dayName = DAYS[todayIdx - 1];
                const todayData = scheduleData[detectedWeek][dayName];
                const todayPairs = (todayData && todayData !== 'practice') ? todayData.map(c => c.pair) : [];

                const current = pairs.find(p => mins >= p.startMin && mins <= p.endMin && todayPairs.includes(p.num));
                if (current) {
                    const left = current.endMin - mins;
                    pairInfo = `${current.num}-—è –ø–∞—Ä–∞ ¬∑ –µ—â—ë ${left} –º–∏–Ω`;
                } else {
                    const next = pairs.find(p => p.startMin > mins && todayPairs.includes(p.num));
                    if (next) {
                        const diff = next.startMin - mins;
                        if (diff <= 120) {
                            pairInfo = `${next.num}-—è –ø–∞—Ä–∞ —á–µ—Ä–µ–∑ ${diff} –º–∏–Ω`;
                        }
                    }
                }
            }

            const weekendMsg = !isWeekday ? 'üò¥ –í—ã—Ö–æ–¥–Ω–æ–π' : '';

            el.innerHTML = `
                <div class="time-chip"><span class="icon">üìÖ</span> ${dayStr}, ${dateStr}</div>
                <div class="time-chip"><span class="icon">üïê</span> ${timeStr}</div>
                <div class="time-chip"><span class="icon">üìÜ</span> ${detectedWeek} –Ω–µ–¥. (${weekLabel})</div>
                <div class="time-chip"><span class="notif-status ${notifGranted ? 'on' : 'off'}" id="notifStatusChip">${notifLabel}</span></div>
                ${pairInfo ? `<div class="time-chip"><span class="icon">üìö</span> ${pairInfo}</div>` : ''}
                ${weekendMsg ? `<div class="time-chip"><span class="icon">üò¥</span> –í—ã—Ö–æ–¥–Ω–æ–π</div>` : ''}
            `;
        }

        // === NOTIFICATIONS ===
        const notifiedClasses = new Set();

        function requestNotifPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                showNotifBanner();
            }
        }

        function showNotifBanner() {
            if (document.querySelector('.notif-banner')) return;
            const banner = document.createElement('div');
            banner.className = 'notif-banner';
            banner.innerHTML = `
                <span>üîî</span>
                <span>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ ${notifLeadTimeMins} –º–∏–Ω –¥–æ –ø–∞—Ä—ã?</span>
                <button class="close-btn" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            `;
            banner.addEventListener('click', async (e) => {
                if (e.target.classList.contains('close-btn')) {
                    banner.remove();
                    return;
                }
                const perm = await Notification.requestPermission();
                banner.remove();
                if (perm === 'granted') {
                    updateNotifStatus();
                }
            });
            document.body.appendChild(banner);
        }

        function updateNotifStatus() {
            const existing = document.getElementById('notifStatusChip');
            if (existing) {
                const granted = Notification.permission === 'granted';
                existing.className = `notif-status ${granted ? 'on' : 'off'}`;
                existing.textContent = granted ? 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª' : 'üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª';
            }
        }

        function checkNotifications() {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;

            const now = new Date();
            const todayIdx = now.getDay(); // 0=Sun, 1=Mon
            if (todayIdx < 1 || todayIdx > 5) return; // Weekend

            const dayName = DAYS[todayIdx - 1];
            const week = detectCurrentWeek();
            const data = scheduleData[week][dayName];
            if (!data || data === 'practice') return;

            const nowMins = now.getHours() * 60 + now.getMinutes();
            const todayKey = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;

            data.forEach(c => {
                const slot = TIME_SLOTS[c.pair - 1];
                const [sh, sm] = slot.start.split(':').map(Number);
                const startMins = sh * 60 + sm;
                const diff = startMins - nowMins;
                const notifKey = `${todayKey}-${c.pair}`;

                if (diff > 0 && diff <= notifLeadTimeMins && !notifiedClasses.has(notifKey)) {
                    notifiedClasses.add(notifKey);
                    new Notification(`üìö ${c.name}`, {
                        body: `–ß–µ—Ä–µ–∑ ${diff} –º–∏–Ω ¬∑ ${slot.start} ¬∑ ${c.room || '–±–µ–∑ –∞—É–¥.'}${c.teacher ? ' ¬∑ ' + c.teacher : ''}`,
                        icon: 'icon-192.png',
                        badge: 'icon-192.png',
                        tag: notifKey,
                    });
                }
            });
        }

        // === PWA SERVICE WORKER ===
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(`sw.js?v=${SW_VERSION}`, { updateViaCache: 'none' }).catch(() => { });
        }

        // === INIT ===
        renderPanelState();

        document.querySelector('.week-toggle').addEventListener('click', (event) => {
            const button = event.target.closest('.week-btn');
            if (!button) return;
            const week = parseInt(button.dataset.week, 10);
            if (!Number.isNaN(week)) switchWeek(week);
        });

        document.getElementById('schedule').addEventListener('click', (event) => {
            const shareBtn = event.target.closest('[data-share="class"]');
            if (shareBtn) {
                const dayNum = Number.parseInt(shareBtn.dataset.day, 10);
                const pairNum = Number.parseInt(shareBtn.dataset.pair, 10);
                if (!Number.isNaN(dayNum) && !Number.isNaN(pairNum)) {
                    shareClass(dayNum, pairNum);
                }
                return;
            }

            const header = event.target.closest('.day-header');
            if (!header) return;
            const dayNum = parseInt(header.dataset.day, 10);
            if (!Number.isNaN(dayNum)) toggleDay(dayNum);
        });

        document.getElementById('schedule').addEventListener('keydown', (event) => {
            const header = event.target.closest('.day-header');
            if (!header) return;
            if (event.key !== 'Enter' && event.key !== ' ') return;
            event.preventDefault();
            const dayNum = parseInt(header.dataset.day, 10);
            if (!Number.isNaN(dayNum)) toggleDay(dayNum);
        });

        document.getElementById('todayModeBtn').addEventListener('click', () => {
            todayModeEnabled = !todayModeEnabled;
            savePanelState();
            renderPanelState();
            applyViewRenders();
        });

        document.getElementById('typeFilter').addEventListener('change', (event) => {
            typeFilterValue = event.target.value;
            savePanelState();
            applyViewRenders();
        });

        document.getElementById('searchInput').addEventListener('input', (event) => {
            searchQueryValue = event.target.value.trim();
            savePanelState();
            applyViewRenders();
        });

        document.getElementById('notifLeadTime').addEventListener('change', (event) => {
            const mins = Number.parseInt(event.target.value, 10);
            if (![5, 10, 15, 30].includes(mins)) return;
            notifLeadTimeMins = mins;
            savePanelState();
        });

        document.getElementById('exportTodayBtn').addEventListener('click', exportTodayICS);
        document.getElementById('exportWeekBtn').addEventListener('click', exportWeekICS);
        document.getElementById('shareTodayBtn').addEventListener('click', shareToday);
        document.getElementById('resetStateBtn').addEventListener('click', resetSettings);

        document.getElementById('changelogCloseBtn').addEventListener('click', () => {
            document.getElementById('changelogBanner').classList.remove('show');
            localStorage.setItem(STORAGE_CHANGELOG_DISMISSED_KEY, scheduleHash);
        });

        window.addEventListener('online', updateOfflineBanner);
        window.addEventListener('offline', updateOfflineBanner);

        // Auto-select detected week
        renderSchedule(currentWeek);
        renderTimeGrid();
        updateCurrentInfo();
        renderStats();
        renderNextClassCard();
        setInterval(() => {
            updateCurrentInfo();
            renderNextClassCard();
        }, 1000); // Update every second
        setInterval(() => {
            renderSchedule(currentWeek);
            renderStats();
        }, 30000);

        // Set active week button on load
        document.querySelectorAll('.week-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.week) === currentWeek);
        });

        // Start notification checks
        updateOfflineBanner();
        setupChangelogBanner();
        requestNotifPermission();
        setInterval(checkNotifications, 30000); // Check every 30 sec
        checkNotifications(); // Check immediately
    </script>
</body>

</html>
